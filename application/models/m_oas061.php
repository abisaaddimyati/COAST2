<?php /************************************************************************************************ * Program History :** Project Name     : OAS* Client Name      : CBI - Muhammad* Program Id       : OAS061* Program Name     : Paid Business Travel* Description      :* Environment      : PHP 5.4.4* Author           : Winni Oktaviani* Version          : 01.00.00* Creation Date    : 25-11-2014 10:20:00 ICT 2014** Update history     Re-fix date       Person in charge      Description* ** Copyright(C) [..]. All Rights Reserved*************************************************************************************************/if (!defined('BASEPATH')) {exit('No direct script access allowed');}class M_OAS061 extends CI_Model {		function __construct() {		parent::__construct();		$this->user	= unserialize(base64_decode($this->session->userdata('user')));	}	 function get_list($data)	{		$sql = "SELECT						                       bt.REF_NO no_ref,                       empl.EMPLOYEE_NAME employee_name,					   empl.EMPLOYEE_ID employee_id,                       usr.USER_EMAIL employee_email,                        bt.BT_ID bt_id,                       bt.EMPLOYEE_ID submitter,                       (select app.EMPLOYEE_NAME from tb_m_employee app where app.EMPLOYEE_ID = bt.EMPLOYEE_ID )  submitter_name,                        bt.CLIENT_NAME client_name,                       bt.CUSTOMER_LOCATION customer_location,                       bt.TRANSPORTATION_BY transport_id,                       (select ref.VALUE from tb_m_system ref  where ref.SYS_CAT= '20' and ref.SYS_CD = bt.TRANSPORTATION_BY)  transport_name,					   bt.CHARGE_CODE chargecode,                       (select ref.VALUE from tb_m_system ref where ref.SYS_CAT= '11' and ref.SYS_CD = cc.TYPE ) typecc_name, 					   cc.PROJECT_DESCRIPTION cc_name,					   fs.TARGET_EMPLOYEE_ID aprove,                         (select app.EMPLOYEE_NAME from tb_m_employee app where app.EMPLOYEE_ID = fs.TARGET_EMPLOYEE_ID )  approve_name,                                   bt.BUSINESS_PURPOSE purpose,                       bt.DESTINATION destination,                       cost.DESTINATION destination_name,                       bt.CURRENCY currency_id,					   bt.TOTAL_AMOUNT_BT total,					   (select ref.VALUE from tb_m_system ref  where ref.SYS_CAT= '16' and ref.SYS_CD = bt.CURRENCY )  currency_name,                       bt.PAYMENT_METHOD pay_method,                       (select ref.VALUE from tb_m_system ref  where ref.SYS_CAT= '17' and ref.SYS_CD = bt.PAYMENT_METHOD )  pay_method_name,                       bt.DEPARTURE departure,                       bt.RETURN_DATE return_date,                       bt.DURATION duration,                       bt.CREATED_DT submitted_dt,					   bt.REMARK remarks,                       bt.TRANSPORTAMOUNT transport_amount,                        sys.VALUE status,					   fs.STATUS status_id,                       fs.CREATED_DT approved_dt,                       fs.CREATED_BY approved_by,                       fs.REMARKS remarks_approval,                       fs.APPROVEDIR_DT approvedga_dt,                       fs.APPROVEDIR_BY approvedga_by,                       fs.REMARKS_DIR remarks_ga,                       fs.UPDATED_DT accepted_dt,                       fs.UPDATED_BY accepted_by,					   fs.STATUS stat				    				FROM 						tb_r_form_status fs,						tb_m_employee empl,						tb_r_bt bt,                        tb_m_charge_code cc,                        tb_m_ca_cost cost,					    tb_m_user usr,					    tb_m_system sys				    				WHERE					   					    bt.TRAVELLER_ID = empl.EMPLOYEE_ID AND					    empl.EMPLOYEE_ID = usr.EMPLOYEE_ID AND					    cc.CHARGE_CODE = bt.CHARGE_CODE AND                        cost.COST_ID = bt.DESTINATION AND                   					    sys.SYS_CAT = '21' AND					    sys.SYS_CD = fs.STATUS AND					    fs.FORM_ID = bt.BT_ID AND					    fs.FORM_TYPE_ID = '3' AND                        fs.STATUS = '3'";			return fetchArray($sql, 'all');	}	function get_search_list($employeeID, $searchparam)	{		$sql = "SELECT						                       bt.REF_NO no_ref,                       empl.EMPLOYEE_NAME employee_name,					   empl.EMPLOYEE_ID employee_id,                       usr.USER_EMAIL employee_email,                        bt.BT_ID bt_id,                       bt.EMPLOYEE_ID submitter,                       (select app.EMPLOYEE_NAME from tb_m_employee app where app.EMPLOYEE_ID = bt.EMPLOYEE_ID )  submitter_name,                        bt.CLIENT_NAME client_name,                       bt.CUSTOMER_LOCATION customer_location,                       bt.TRANSPORTATION_BY transport_id,                       (select ref.VALUE from tb_m_system ref  where ref.SYS_CAT= '20' and ref.SYS_CD = bt.TRANSPORTATION_BY)  transport_name,					   bt.CHARGE_CODE chargecode,                       (select ref.VALUE from tb_m_system ref where ref.SYS_CAT= '11' and ref.SYS_CD = cc.TYPE ) typecc_name, 					   cc.PROJECT_DESCRIPTION cc_name,					   fs.TARGET_EMPLOYEE_ID aprove,                         (select app.EMPLOYEE_NAME from tb_m_employee app where app.EMPLOYEE_ID = fs.TARGET_EMPLOYEE_ID )  approve_name,                                   bt.BUSINESS_PURPOSE purpose,                       bt.DESTINATION destination,                       cost.DESTINATION destination_name,                       bt.CURRENCY currency_id,					   (select ref.VALUE from tb_m_system ref  where ref.SYS_CAT= '16' and ref.SYS_CD = bt.CURRENCY )  currency_name,                       bt.PAYMENT_METHOD pay_method,                       (select ref.VALUE from tb_m_system ref  where ref.SYS_CAT= '17' and ref.SYS_CD = bt.PAYMENT_METHOD )  pay_method_name,                       bt.DEPARTURE departure,                       bt.RETURN_DATE return_date,                       bt.DURATION duration,                       bt.CREATED_DT submitted_dt,					   bt.REMARK remarks,                       bt.TRANSPORTAMOUNT transport_amount,                        sys.VALUE status,					   fs.STATUS status_id,                       fs.CREATED_DT approved_dt,                       fs.CREATED_BY approved_by,                       fs.REMARKS remarks_approval,                       fs.APPROVEDIR_DT approvedga_dt,                       fs.APPROVEDIR_BY approvedga_by,                       fs.REMARKS_DIR remarks_ga,                       fs.UPDATED_DT accepted_dt,                       fs.UPDATED_BY accepted_by,					   fs.STATUS stat				    				FROM 						tb_r_form_status fs,						tb_m_employee empl,						tb_r_bt bt,                        tb_m_charge_code cc,                        tb_m_ca_cost cost,					    tb_m_user usr,					    tb_m_system sys				    				WHERE					   					    bt.TRAVELLER_ID = empl.EMPLOYEE_ID AND					    empl.EMPLOYEE_ID = usr.EMPLOYEE_ID AND					    cc.CHARGE_CODE = bt.CHARGE_CODE AND                        cost.COST_ID = bt.DESTINATION AND                   					    sys.SYS_CAT = '21' AND					    sys.SYS_CD = fs.STATUS AND					    fs.FORM_ID = bt.BT_ID AND					    fs.FORM_TYPE_ID = '3' AND                        fs.STATUS = '3'				  ";					if($searchparam['employeeid'] != ''){			$sql .=	" AND  bt.TRAVELLER_ID = '$searchparam[employeeid]' ";		}		if($searchparam['employeename'] != ''){			$sql .=	" AND  empl.EMPLOYEE_ID = '$searchparam[employeename]' ";		}		if($searchparam['PBTdestination'] != ''){			$sql .=	" AND  bt.DESTINATION  = '$searchparam[PBTdestination]' ";		}						if($searchparam['group_id'] != ''){			$sql .=	" AND  empl.GROUP_ID = '$searchparam[group_id]' ";		}		if($searchparam['division_id'] != ''){			$sql .=	" AND  empl.DIVISION_ID = '$searchparam[division_id]' ";		}				if($searchparam['year'] != ''){			$sql .=	" AND  YEAR(bt.CREATED_DT) = '$searchparam[year]' ";		}		if($searchparam['month'] != ''){			$sql .=	" AND  MONTH(bt.CREATED_DT) = '$searchparam[month]'  ";		}		$sql .=	"  				ORDER BY				    	fs.STATUS asc ";		return fetchArray($sql, 'all');	}	function get_group_list()	{		$sql = " SELECT							pos.POSITION_ID id,							pos.POSITION_NAME name																		FROM							tb_m_position pos 				WHERE							pos.POSITION_DEPTH_ID = '2' ";		return fetchArray($sql, 'all');	}	function get_division_list($group_id = '')	{		$sql = " SELECT							pos.POSITION_ID id,							pos.POSITION_NAME name																		FROM							tb_m_position pos 				WHERE							pos.POSITION_DEPTH_ID = '3' ";		if($group_id !=''){			$sql .= "AND pos.MANAGER_ID = '$group_id' ";			}		return fetchArray($sql, 'all');	}		function get_destination_list()	{		$sql = "  SELECT							COST_ID id,							DESTINATION name																		FROM							tb_m_ca_cost";		return fetchArray($sql, 'all');	}	function get_employee_list()	{		$sql = " SELECT							empl.EMPLOYEE_ID,							empl.EMPLOYEE_NAME											FROM							tb_m_employee empl				ORDER BY empl.EMPLOYEE_NAME ASC ";		return fetchArray($sql, 'all');	}	function paid_selected()	{	$loop = $this->input->post('loop');	$empid    = $this->user['id'];	$email = $this->user['email'];		for($a=1;$a<=$loop;$a++){			$checkbox = $this->input->post('checkbox'.$a);			 $recipient= $this->input->post('PBT-emp-id'.$a);			 $refno= $this->input->post('PBT-no-ref'.$a);						if(empty($checkbox)){							}else{			$sql = "UPDATE 						tb_r_form_status 					SET 						STATUS='9',						UPDATED_DT 		= '".date("Y-m-d H:i:s")."'				WHERE						FORM_TYPE_ID = '3' AND						FORM_ID ='" . $checkbox . "'";		$sql_notif = "INSERT INTO						tb_r_notification (RECIPIENT_EMPLOYEE_ID,									SENDER_EMPLOYEE_ID,									ACTIVITY_TYPE_ID,									FORM_TYPE_ID,									FORM_ID,									NOTIFICATION_INFORMATION,									NOTIFICATION_STATUS_ID,									NOTIFICATION_TIME,									CREATED_BY,									CREATED_DT)				VALUES						('".$recipient."',						'".$empid."',						'6',						'3',						'" . $checkbox . "',						'No. Ref: ".$refno."',						'1',						'".date("Y-m-d H:i:s")."',						'user:".$email."',						'".date("Y-m-d H:i:s")."')";						$this->db->trans_start();			$this->db->query($sql);			$this->db->query($sql_notif);			$this->db->trans_complete();}	}			return true;	}	 }